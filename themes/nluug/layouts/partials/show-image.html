{{ if .link }}<a href="{{ .link }}">{{ end }}
{{ $height := 200 }}
{{ $width := 200 }}
{{ if .height }}{{ $height = .height }}{{ end }}
{{ if .width }}{{ $width = .width }}{{ end }}
<figure>
  <picture>
    {{ $isJPG := eq (path.Ext .image) ".jpg" }}
    {{ $isPNG := eq (path.Ext .image) ".png" }}
    {{ $isSVG := eq (path.Ext .image) ".svg" }}

    {{ if ($isJPG) -}}
      {{ $webpPath:= replace .image ".jpg" ".webp" }}
      {{ $webpPathStatic:= printf "static/%s" $webpPath }}

      {{ if (fileExists $webpPathStatic) -}}
        <source srcset="{{ $webpPath | safeURL }}" type="image/webp">
      {{- end }}
    {{- end }}

    {{ if ($isPNG) -}}
      {{ $webpPath:= replace .image ".png" ".webp" }}
      {{ $webpPathStatic:= printf "static/%s" $webpPath }}

      {{ if (fileExists $webpPathStatic) -}}
        <source srcset="{{ $webpPath | safeURL }}" type="image/webp">
      {{- end }}
    {{- end }}

    {{ if or ($isJPG) ($isPNG) }}
        {{ $img := imageConfig (add "/static" (.image | safeURL)) }}
        <img src="{{ .image | safeURL }}" alt="{{ .alt }}"{{ if not .above_the_fold }} loading="lazy"{{ end }} decoding="async" width="{{ $img.Width }}" height="{{ $img.Height }}">
    {{ else if ($isSVG) }}
    <img src="{{ .image | safeURL }}" alt="{{ .alt }}"{{ if not .above_the_fold }} loading="lazy"{{ end }} decoding="async" width="{{ $width | default 200 }}" height="{{ $height | default 200 }}">
    {{ end }}
  </picture>
  {{ if .figcaption }}
    <figcaption>
      <small><strong>{{ .figcaption }}</strong></small>
    </figcaption>
  {{ end }}
</figure>
{{ if .link }}</a>{{ end }}
